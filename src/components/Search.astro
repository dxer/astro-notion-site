---
import { getCurrentLanguage, getTranslations } from '../lib/i18n';

const currentLang = getCurrentLanguage();
const t = getTranslations(currentLang);
---

<!-- Search Modal -->
<div id="search-modal" class="fixed inset-0 z-50 hidden">
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-background/80 backdrop-blur-sm" id="search-backdrop"></div>
  
  <!-- Modal Content -->
  <div class="relative flex items-start justify-center min-h-screen pt-16 px-4">
    <div class="w-full max-w-2xl bg-card border border-border rounded-xl shadow-2xl">
      <!-- Search Input -->
      <div class="p-4 border-b border-border">
        <div class="relative">
          <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-foreground/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <input
            id="search-input"
            type="text"
            placeholder={t.searchPlaceholder}
            class="w-full pl-10 pr-4 py-3 bg-transparent text-foreground placeholder:text-foreground/50 focus:outline-none text-lg"
            autocomplete="off"
          />
          <button
            id="search-close"
            class="absolute right-3 top-1/2 -translate-y-1/2 p-1 rounded-md hover:bg-secondary transition-colors"
          >
            <svg class="w-4 h-4 text-foreground/50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
      </div>
      
      <!-- Search Results -->
      <div id="search-results" class="max-h-96 overflow-y-auto">
        <div id="search-empty" class="p-8 text-center text-foreground/50">
          <svg class="w-12 h-12 mx-auto mb-4 text-foreground/30" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <circle cx="11" cy="11" r="8"></circle>
            <path d="m21 21-4.35-4.35"></path>
          </svg>
          <p>{t.searchEmpty}</p>
        </div>
        
        <div id="search-loading" class="hidden p-8 text-center">
          <div class="animate-spin w-6 h-6 border-2 border-foreground/20 border-t-foreground rounded-full mx-auto mb-4"></div>
          <p class="text-foreground/50">{t.searching}</p>
        </div>
        
        <div id="search-list" class="hidden"></div>
      </div>
      
      <!-- Search Footer -->
      <div class="p-4 border-t border-border text-xs text-foreground/50 flex items-center justify-between">
        <span>{t.searchHint}</span>
        <div class="flex items-center gap-2">
          <kbd class="px-2 py-1 bg-secondary rounded text-xs">ESC</kbd>
          <span>{t.toClose}</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  interface SearchResult {
    title: string;
    slug: string;
    description: string;
    tags: string[];
    publishDate: string;
  }

  let searchData: SearchResult[] = [];
  
  // Load search data
  async function loadSearchData() {
    try {
      const response = await fetch('/api/search.json');
      searchData = await response.json();
    } catch (error) {
      console.error('Failed to load search data:', error);
    }
  }
  
  // Search function
  function performSearch(query: string): SearchResult[] {
    if (!query.trim()) return [];
    
    const searchTerm = query.toLowerCase();
    return searchData.filter(post => 
      post.title.toLowerCase().includes(searchTerm) ||
      post.description.toLowerCase().includes(searchTerm) ||
      post.tags.some(tag => tag.toLowerCase().includes(searchTerm))
    ).slice(0, 10); // Limit to 10 results
  }
  
  // Render search results
  function renderResults(results: SearchResult[]) {
    const searchList = document.getElementById('search-list');
    const searchEmpty = document.getElementById('search-empty');
    
    if (!searchList || !searchEmpty) return;
    
    if (results.length === 0) {
      searchList.classList.add('hidden');
      searchEmpty.classList.remove('hidden');
      return;
    }
    
    searchEmpty.classList.add('hidden');
    searchList.classList.remove('hidden');
    
    searchList.innerHTML = results.map(result => `
      <a href="/posts/${result.slug}" class="block p-4 hover:bg-secondary transition-colors border-b border-border last:border-b-0">
        <div class="space-y-2">
          <h3 class="font-medium text-foreground line-clamp-1">${result.title}</h3>
          <p class="text-sm text-foreground/60 line-clamp-2">${result.description}</p>
          <div class="flex items-center gap-2 text-xs text-foreground/50">
            <span>${new Date(result.publishDate).toLocaleDateString()}</span>
            ${result.tags.length > 0 ? `<span>â€¢</span><span>${result.tags.join(', ')}</span>` : ''}
          </div>
        </div>
      </a>
    `).join('');
  }
  
  // Initialize search
  function initSearch() {
    const searchModal = document.getElementById('search-modal');
    const searchToggle = document.getElementById('search-toggle');
    const searchClose = document.getElementById('search-close');
    const searchBackdrop = document.getElementById('search-backdrop');
    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    
    if (!searchModal || !searchToggle || !searchClose || !searchBackdrop || !searchInput) return;
    
    // Load search data
    loadSearchData();
    
    // Open search
    function openSearch() {
      if (searchModal) {
        searchModal.classList.remove('hidden');
        searchInput?.focus();
        document.body.style.overflow = 'hidden';
      }
    }
    
    // Close search
    function closeSearch() {
      if (searchModal) {
        searchModal.classList.add('hidden');
        if (searchInput) searchInput.value = '';
        document.body.style.overflow = '';
        renderResults([]);
      }
    }
    
    // Event listeners
    searchToggle.addEventListener('click', openSearch);
    searchClose.addEventListener('click', closeSearch);
    searchBackdrop.addEventListener('click', closeSearch);
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      if (e.key === '/' && !searchModal.classList.contains('hidden') === false) {
        e.preventDefault();
        openSearch();
      }
      if (e.key === 'Escape' && !searchModal.classList.contains('hidden')) {
        closeSearch();
      }
    });
    
    // Search input
    let searchTimeout: number;
    searchInput.addEventListener('input', (e) => {
      const query = (e.target as HTMLInputElement).value;
      
      clearTimeout(searchTimeout);
      searchTimeout = window.setTimeout(() => {
        const results = performSearch(query);
        renderResults(results);
      }, 300);
    });
  }
  
  // Initialize on page load
  initSearch();
  
  // Re-initialize on navigation
  document.addEventListener('astro:page-load', initSearch);
</script>