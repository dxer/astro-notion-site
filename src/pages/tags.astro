---
import Layout from '../layouts/Layout.astro';
import Navigation from '../components/Navigation.astro';
import PostCard from '../components/PostCard.astro';
import Footer from '../components/Footer.astro';
import { getPosts, type BlogPost } from '../lib/notion';
import { getCurrentLanguage, getTranslations } from '../lib/i18n';

const currentLang = getCurrentLanguage();
const t = getTranslations(currentLang);

let posts: BlogPost[] = [];
try {
  posts = await getPosts();
} catch (error) {
  console.error('Failed to fetch posts:', error);
  // In development, show mock data
  if (import.meta.env.DEV) {
    posts = [
      {
        id: '1',
        title: 'React 18 新特性深度解析',
        slug: 'react-18-features',
        status: 'published',
        description: '探讨 React 18 中的并发特性、自动批处理和 Suspense 的最新进展...',
        tags: ['React', 'JavaScript'],
        publishDate: '2024-12-01',
        cover: ''
      },
      {
        id: '2',
        title: 'Next.js 15 App Router 最佳实践',
        slug: 'nextjs-app-router-best-practices',
        status: 'published',
        description: '分享在生产环境中使用 App Router 的经验和优化技巧...',
        tags: ['Next.js', 'React'],
        publishDate: '2024-11-28',
        cover: ''
      },
      {
        id: '3',
        title: 'Web 性能优化指南',
        slug: 'web-performance-optimization',
        status: 'published',
        description: '从核心 Web 指标到实际优化方案，全面提升网站性能...',
        tags: ['Performance', 'Web'],
        publishDate: '2024-11-15',
        cover: ''
      },
      {
        id: '4',
        title: 'TypeScript 高级类型系统',
        slug: 'typescript-advanced-types',
        status: 'published',
        description: 'TypeScript 中的高级类型系统和实用技巧...',
        tags: ['TypeScript', 'JavaScript'],
        publishDate: '2024-11-10',
        cover: ''
      }
    ];
  }
}

// Extract all unique tags and count posts per tag
const tagCounts = new Map<string, number>();
const tagPosts = new Map<string, BlogPost[]>();

posts.forEach(post => {
  post.tags.forEach(tag => {
    tagCounts.set(tag, (tagCounts.get(tag) || 0) + 1);
    if (!tagPosts.has(tag)) {
      tagPosts.set(tag, []);
    }
    tagPosts.get(tag)!.push(post);
  });
});

// Sort tags by post count (descending)
const sortedTags = Array.from(tagCounts.entries())
  .sort(([, a], [, b]) => b - a)
  .map(([tag]) => tag);

// Get selected tag from URL params
const url = new URL(Astro.request.url);
const selectedTag = url.searchParams.get('tag');
const filteredPosts = selectedTag ? (tagPosts.get(selectedTag) || []) : posts;
---

<Layout title={selectedTag ? `${t.tag}: ${selectedTag}` : t.allTags} description={selectedTag ? `${t.postsTaggedWith} ${selectedTag}` : t.browseAllTags}>
  <main class="min-h-screen bg-background">
    <Navigation />

    <!-- Tags Header -->
    <section class="max-w-7xl mx-auto px-6 py-16 md:py-24">
      <div class="space-y-8">
        <!-- Page Title -->
        <div class="space-y-4">
          <h1 class="text-4xl md:text-5xl font-bold">
            {selectedTag ? `${t.tag}: ${selectedTag}` : t.allTags}
          </h1>
          <p class="text-foreground/60 text-lg">
            {selectedTag 
              ? `${filteredPosts.length} ${t.postsFound}` 
              : `${t.browseTagsDescription} ${posts.length} ${t.totalPosts}`
            }
          </p>
        </div>

        <!-- Back to all tags if viewing specific tag -->
        {selectedTag && (
          <div>
            <a 
              href="/tags" 
              class="inline-flex items-center gap-2 text-sm text-foreground/60 hover:text-foreground transition-colors"
            >
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12,19 5,12 12,5"></polyline>
              </svg>
              {t.backToAllTags}
            </a>
          </div>
        )}

        <!-- Enhanced Tags Cloud -->
        {!selectedTag && (
          <div class="space-y-6">
            <h2 class="text-2xl font-semibold">{t.browseByTag}</h2>
            <div class="relative">
              <!-- Tag cloud with size-based visualization -->
              <div class="flex flex-wrap gap-3 items-center justify-center p-8 bg-gradient-to-br from-secondary/30 to-secondary/10 rounded-2xl border border-border/50">
                {sortedTags.map((tag, index) => {
                  const count = tagCounts.get(tag) || 0;
                  const maxCount = Math.max(...Array.from(tagCounts.values()));
                  const minCount = Math.min(...Array.from(tagCounts.values()));
                  const normalizedSize = maxCount === minCount ? 1 : (count - minCount) / (maxCount - minCount);
                  const fontSize = 0.75 + (normalizedSize * 0.75); // 0.75rem to 1.5rem
                  const opacity = 0.6 + (normalizedSize * 0.4); // 60% to 100% opacity
                  
                  return (
                    <a
                      href={`/tags?tag=${encodeURIComponent(tag)}`}
                      class="group inline-flex items-center gap-2 px-3 py-2 bg-background/80 hover:bg-background border border-border/50 hover:border-foreground/30 rounded-full transition-all duration-300 hover:scale-110 hover:shadow-lg"
                      style={`font-size: ${fontSize}rem; opacity: ${opacity};`}
                    >
                      <span class="font-medium text-foreground/80 group-hover:text-foreground transition-colors">
                        {tag}
                      </span>
                      <span class="text-xs text-foreground/50 bg-secondary px-1.5 py-0.5 rounded-full min-w-[1.25rem] text-center">
                        {count}
                      </span>
                    </a>
                  );
                })}
              </div>
              
              <!-- Decorative elements -->
              <div class="absolute -top-2 -left-2 w-4 h-4 bg-gradient-to-br from-vercel-blue to-vercel-cyan rounded-full opacity-20"></div>
              <div class="absolute -bottom-2 -right-2 w-6 h-6 bg-gradient-to-br from-vercel-pink to-vercel-purple rounded-full opacity-15"></div>
            </div>
            
            <!-- Alternative list view for smaller screens -->
            <div class="md:hidden space-y-3">
              <h3 class="text-lg font-medium text-foreground/80">{t.allTags}</h3>
              <div class="grid grid-cols-2 gap-2">
                {sortedTags.map(tag => (
                  <a
                    href={`/tags?tag=${encodeURIComponent(tag)}`}
                    class="group flex items-center justify-between p-3 bg-secondary hover:bg-foreground/5 border border-border hover:border-foreground/20 rounded-lg transition-all duration-200"
                  >
                    <span class="font-medium text-foreground/80 group-hover:text-foreground text-sm">
                      {tag}
                    </span>
                    <span class="text-xs text-foreground/50 bg-background px-2 py-1 rounded-full">
                      {tagCounts.get(tag)}
                    </span>
                  </a>
                ))}
              </div>
            </div>
          </div>
        )}
      </div>
    </section>

    <!-- Posts Section -->
    <section class="max-w-7xl mx-auto px-6 pb-16 md:pb-24">
      <div class="space-y-8">
        {selectedTag && (
          <div class="flex items-center justify-between">
            <h2 class="text-2xl font-semibold">
              {t.postsTaggedWith} "{selectedTag}"
            </h2>
            <span class="text-sm text-foreground/60">
              {filteredPosts.length} {t.postsFound}
            </span>
          </div>
        )}

        {filteredPosts.length > 0 ? (
          <div class="grid gap-6 md:gap-8 lg:grid-cols-2 xl:grid-cols-3">
            {filteredPosts.map((post, index) => (
              <PostCard post={post} index={index} />
            ))}
          </div>
        ) : (
          <div class="text-center py-16">
            <div class="space-y-4">
              <svg class="w-16 h-16 mx-auto text-foreground/20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"></path>
              </svg>
              <h3 class="text-xl font-semibold text-foreground/60">{t.noPostsFound}</h3>
              <p class="text-foreground/50">{t.noPostsFoundDescription}</p>
              <a 
                href="/tags" 
                class="inline-flex items-center gap-2 mt-4 px-4 py-2 bg-foreground text-background rounded-md hover:bg-foreground/90 transition-colors"
              >
                {t.browseAllTags}
              </a>
            </div>
          </div>
        )}
      </div>
    </section>

    <Footer />
  </main>
</Layout>